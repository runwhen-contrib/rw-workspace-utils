# .github/workflows/pypi.yaml
name: Publish Pypi Package

on:
  push:
    branches:
      - main
    paths:
      - 'libraries/**'
      - '.github/workflows/pypi.yaml'
  workflow_dispatch:

env:
  PIP_PACKAGE_NAME: rw_workspace_utils_keywords

jobs:
  publish-pypi:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Fetch tags
        run: git fetch --force --tags --prune

      - name: Generate date-based version
        run: |-
          # Define the date format for the version: YYYY.MM.DD
          DATE_FORMAT="+%Y.%m.%d"
          
          # Generate the base version based on the current date
          BASE_VERSION=$(date "$DATE_FORMAT")
          
          # Function to find the next release number for today
          get_next_release_number() {
              local last_number=$(git tag | grep "^pypi-$BASE_VERSION" | awk -F '.' '{print $NF}' | sort -n | tail -1)
              if [ -z "$last_number" ]; then
                  echo 1  # If no tags found for today, start with .1
              else
                  echo $((last_number + 1))  # Increment the last number by 1
              fi
          }
          
          NEXT_RELEASE_NUMBER=$(get_next_release_number)
          VERSION="$BASE_VERSION.$NEXT_RELEASE_NUMBER"
          
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Generated version: $VERSION"
          
          # Create a tag for tracking PyPI releases
          git config user.name "${GITHUB_ACTOR}"
          git config user.email "${GITHUB_ACTOR}@users.noreply.github.com"
          git tag "pypi-$VERSION"
          git push origin "pypi-$VERSION" || echo "Tag already exists or push failed (non-fatal)"

      - name: Install dependencies
        run: |
          pip install --upgrade packaging setuptools wheel build twine

      - name: Update version in pyproject.toml
        run: |
          echo "Setting version to ${VERSION} in pyproject.toml"
          sed -i "s/^version = \"0.0.0\"/version = \"${VERSION}\"/" pyproject.toml
          grep "^version = " pyproject.toml

      - name: Build Package (PEP 517)
        run: |
          # Clean old build artifacts first:
          rm -rf dist build *.egg-info
          echo "Building package with version: ${VERSION}"
          # Use the modern build command:
          python -m build

      - name: Check distribution
        run: |
          twine check dist/*

      - name: Publish
        run: |
          twine upload dist/* -u __token__ -p ${{ secrets.PYPI_TOKEN }}

      - name: Notify Slack of pip update
        uses: slackapi/slack-github-action@v1.19.0
        with:
          channel-id: "#codecollections"
          slack-message: "Just deployed version ${{ env.VERSION }} of ${{ env.PIP_PACKAGE_NAME}} to https://pypi.org/project/${{ env.PIP_PACKAGE_NAME }}"
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
